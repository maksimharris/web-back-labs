{% extends "base.html" %}

{% block lab %}–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 9{% endblock %}

{% block main %}
<style>
    .new-year-page {
        min-height: 100vh;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        position: relative;
        overflow: hidden;
        padding: 20px;
    }
    
    .container {
        position: relative;
        z-index: 2;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .header {
        text-align: center;
        margin-bottom: 40px;
        padding: 30px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        border: 2px solid rgba(255, 215, 0, 0.3);
    }
    
    .title {
        font-size: 48px;
        font-weight: bold;
        color: gold;
        text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        margin-bottom: 10px;
    }
    
    .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: rgba(255, 255, 255, 0.15);
        padding: 20px;
        border-radius: 15px;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .stat-value {
        font-size: 32px;
        font-weight: bold;
        color: gold;
        margin: 10px 0;
    }
    
    .play-area {
        height: 600px;
        position: relative;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 20px;
        border: 2px dashed rgba(255, 215, 0, 0.3);
        margin-bottom: 30px;
        overflow: hidden;
    }
    
    .gift {
        position: absolute;
        width: 80px;
        height: 80px;
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 3;
    }
    
    .gift:hover {
        transform: scale(1.1);
    }
    
    .gift.opened {
        cursor: default;
        opacity: 0.5;
    }
    
    .gift img {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }
    
    .lock-icon {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(0,0,0,0.7);
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
    }
    
    .buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 30px;
    }
    
    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-primary {
        background: gold;
        color: #333;
    }
    
    .btn-santa {
        background: #FF0000;
        color: white;
        border: 2px solid gold;
    }
    
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }
    
    .modal-content {
        background: linear-gradient(135deg, #ffcc00 0%, #ff9900 100%);
        padding: 40px;
        border-radius: 20px;
        text-align: center;
        max-width: 500px;
        width: 90%;
        animation: modalAppear 0.5s ease;
        border: 3px solid white;
    }
    
    .alert {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 10px;
        color: white;
        z-index: 1001;
        animation: slideIn 0.3s ease;
    }
    
    .alert-success {
        background: #4CAF50;
    }
    
    .alert-error {
        background: #f44336;
    }
</style>

<div class="new-year-page">
    <div class="container">
        <div class="header">
            <h1 class="title">üéÅ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ü–æ–¥–∞—Ä–∫–∏ üéÑ</h1>
            <p style="color: #ffcc00;">–ù–∞–π–¥–∏ —Å–ø—Ä—è—Ç–∞–Ω–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏ –∏ –ø–æ–ª—É—á–∏ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è!</p>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div style="color: #ccc;">–û—Ç–∫—Ä—ã—Ç–æ –≤–∞–º–∏</div>
                <div class="stat-value" id="opened-count">0/3</div>
            </div>
            <div class="stat-card">
                <div style="color: #ccc;">–û—Å—Ç–∞–ª–æ—Å—å –ø–æ–¥–∞—Ä–∫–æ–≤</div>
                <div class="stat-value" id="remaining-gifts">10</div>
            </div>
            <div class="stat-card">
                <div style="color: #ccc;">–ú–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å</div>
                <div class="stat-value" id="can-open">3</div>
            </div>
        </div>
        
        <div class="play-area" id="play-area">
            <!-- –ü–æ–¥–∞—Ä–∫–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
        </div>
        
        <div class="buttons">
            {% if current_user.is_authenticated %}
                <button class="btn btn-santa" onclick="refillGifts()">
                    üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑ (–Ω–∞–ø–æ–ª–Ω–∏—Ç—å –∫–æ—Ä–æ–±–∫–∏)
                </button>
                <button class="btn" onclick="resetSession()" style="background: #9C27B0; color: white;">
                    üé≠ –°–±—Ä–æ—Å–∏—Ç—å –º–æ–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è
                </button>
            {% else %}
                <a href="/lab8/login" class="btn btn-primary">
                    üîê –í–æ–π—Ç–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫–æ –≤—Å–µ–º –ø–æ–¥–∞—Ä–∫–∞–º
                </a>
            {% endif %}
            <button class="btn" onclick="resetGifts()" style="background: #666; color: white;">
                üîÑ –°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë
            </button>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
    <div class="modal" id="gift-modal">
        <div class="modal-content">
            <h2 style="color: #333;">üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! üéâ</h2>
            <img id="modal-gift-img" class="gift-image" src="" alt="–ü–æ–¥–∞—Ä–æ–∫" style="width: 150px; height: 150px;">
            <div id="modal-congratulation" style="font-size: 20px; color: #333; margin: 20px 0;"></div>
            <button class="btn btn-primary" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>

<script>
    
    // –ü—Ä–æ—Å—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    async function loadGifts() {
        try {
            const response = await fetch('/lab9/get_gifts');
            const data = await response.json();
            
            if (data.error) {
                showAlert(data.error, 'error');
                return;
            }
            
            updateStats(data);
            renderGifts(data.gifts);
            
        } catch (error) {
            showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥–∞—Ä–∫–æ–≤', 'error');
        }
    }
    
     {
        document.getElementById('opened-count').textContent = 
            `${data.opened_count}/${data.max_gifts}`;
        document.getElementById('remaining-gifts').textContent = 
            data.total_unopened;
        document.getElementById('can-open').textContent = 
            data.max_gifts - data.opened_count;
    }
    
    function renderGifts(gifts) {
        const area = document.getElementById('play-area');
        area.innerHTML = '';
        
        gifts.forEach(gift => {
            const giftDiv = document.createElement('div');
            giftDiv.className = `gift ${gift.is_opened || gift.opened_by_user ? 'opened' : ''}`;
            giftDiv.style.left = `${gift.x}%`;
            giftDiv.style.top = `${gift.y}%`;
            giftDiv.dataset.id = gift.id;
            
            // –í—ã–±–∏—Ä–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            const imgUrl = gift.is_opened || gift.opened_by_user 
                ? gift.gift_image_url
                : gift.box_image_url;
            
            giftDiv.innerHTML = `
                <img src="${imgUrl}" alt="–ü–æ–¥–∞—Ä–æ–∫">
                ${gift.requires_auth && !gift.can_user_open ? 
                    '<div class="lock-icon">üîí</div>' : ''}
            `;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
            if (!gift.is_opened && !gift.opened_by_user && gift.can_user_open) {
                giftDiv.addEventListener('click', () => openGift(gift.id));
            }
            
            area.appendChild(giftDiv);
        });
    }
    
    async function openGift(giftId) {
        try {
            const response = await fetch(`/lab9/open_gift/${giftId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });
            
            const result = await response.json();
            
            if (result.success) {
                showCongratulation(result);
                loadGifts();
                showAlert(result.message, 'success');
            } else {
                showAlert(result.message, 'error');
            }
        } catch (error) {
            showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø–æ–¥–∞—Ä–∫–∞', 'error');
        }
    }
    
    function showCongratulation(result) {
        const modal = document.getElementById('gift-modal');
        const img = document.getElementById('modal-gift-img');
        const text = document.getElementById('modal-congratulation');
        
        img.src = result.gift_image_url;
        text.textContent = result.congratulation;
        modal.style.display = 'flex';
    }
    
    function closeModal() {
        document.getElementById('gift-modal').style.display = 'none';
    }
    
    async function refillGifts() {
        if (!confirm('üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑, –≤—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –Ω–∞–ø–æ–ª–Ω–∏—Ç—å –≤—Å–µ –∫–æ—Ä–æ–±–∫–∏ –Ω–æ–≤—ã–º–∏ –ø–æ–¥–∞—Ä–∫–∞–º–∏?')) {
            return;
        }
        
        try {
            const response = await fetch('/lab9/refill_gifts', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });
            
            const result = await response.json();
            
            if (result.success) {
                showAlert(result.message, 'success');
                setTimeout(loadGifts, 1000);
            } else {
                showAlert(result.message, 'error');
            }
        } catch (error) {
            showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ—Ä–æ–±–æ–∫', 'error');
        }
    }
    
    async function resetSession() {
        try {
            await fetch('/lab9/reset_session');
            showAlert('–í–∞—à–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–±—Ä–æ—à–µ–Ω—ã', 'success');
            loadGifts();
        } catch (error) {
            showAlert('–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ —Å–µ—Å—Å–∏–∏', 'error');
        }
    }
    
    async function resetGifts() {
        if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –ø–æ–¥–∞—Ä–∫–∏?')) {
            try {
                await fetch('/lab9/reset');
                showAlert('–í—Å–µ –ø–æ–¥–∞—Ä–∫–∏ —Å–±—Ä–æ—à–µ–Ω—ã', 'success');
                setTimeout(() => location.reload(), 1000);
            } catch (error) {
                showAlert('–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞', 'error');
            }
        }
    }
    
    function showAlert(message, type) {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.textContent = message;
        
        document.querySelector('.new-year-page').appendChild(alert);
        
        setTimeout(() => {
            alert.style.opacity = '0';
            setTimeout(() => alert.remove(), 300);
        }, 3000);
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', loadGifts);
</script>
{% endblock %}